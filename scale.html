<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីរចនាជញ្ជីង</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;700&display=swap');
        body { font-family: 'Kantumruy Pro', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        input[type="range"] { cursor: pointer; }
    </style>
</head>
<body class="bg-slate-100 p-4 text-slate-800">

    <div class="flex flex-col md:flex-row min-h-screen max-w-[1600px] mx-auto gap-4">
        <!-- Sidebar Controls -->
        <div class="w-full md:w-[420px] bg-white p-6 rounded-3xl shadow-2xl border border-slate-200 overflow-y-auto max-h-[95vh] space-y-6 custom-scrollbar">
            <div class="flex items-center gap-2 text-teal-700">
                <i class="fa-solid fa-scale-balanced text-2xl"></i>
                <h1 class="text-lg font-bold uppercase italic tracking-tight">រចនាជញ្ជីង</h1>
            </div>

            <!-- Section 1: Styles & Colors -->
            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase flex items-center gap-1"><i class="fa-solid fa-expand text-[10px]"></i> ប្រភេទជញ្ជីង</label>
                    <select id="scaleType" class="w-full p-2 border-2 rounded-xl bg-white text-xs font-bold outline-none"></select>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase flex items-center gap-1"><i class="fa-solid fa-layer-group text-[10px]"></i> ម៉ូដតួ</label>
                        <select id="designStyle" class="w-full p-2 border-2 rounded-xl bg-white text-xs font-bold outline-none"></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase flex items-center gap-1"><i class="fa-solid fa-box text-[10px]"></i> ម៉ូដចាន 3D</label>
                        <select id="trayStyle" class="w-full p-2 border-2 rounded-xl bg-white text-xs font-bold outline-none"></select>
                    </div>
                </div>

                <div class="space-y-4 pt-2 border-t">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase flex items-center gap-1"><i class="fa-solid fa-palette text-[10px]"></i> ពណ៌តួជញ្ជីង</label>
                        <div id="scaleColors" class="flex flex-wrap gap-1 p-1 bg-white rounded-lg border"></div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase flex items-center gap-1"><i class="fa-solid fa-desktop text-[10px]"></i> ពណ៌ស៊ុមមុខជញ្ជីង</label>
                        <div id="dialBorderColors" class="flex flex-wrap gap-1 p-1 bg-white rounded-lg border"></div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase flex items-center gap-1"><i class="fa-solid fa-circle-dot text-[10px]"></i> ពណ៌ចាន</label>
                        <div id="trayColors" class="flex flex-wrap gap-1 p-1 bg-white rounded-lg border"></div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Images -->
            <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-200 space-y-4">
                <div class="flex justify-between items-center">
                    <label class="text-sm font-bold text-indigo-700 uppercase flex items-center gap-2"><i class="fa-solid fa-upload"></i> រូបភាពលើចាន</label>
                    <button onclick="document.getElementById('fileInput').click()" class="p-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-all shadow-md active:scale-90"><i class="fa-solid fa-plus"></i></button>
                </div>
                <input type="file" id="fileInput" hidden accept="image/*">
                <div id="imageThumbnails" class="flex gap-2 overflow-x-auto py-1"></div>
                
                <div id="imageControls" class="hidden space-y-3 border-t border-indigo-100 pt-3">
                    <div class="flex justify-between items-center">
                        <span id="selectedImageLabel" class="text-[10px] font-bold text-indigo-500 uppercase">កែរូបភាព</span>
                        <button onclick="deleteSelectedImage()" class="text-red-500 hover:text-red-700 transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1"><span class="text-[10px] font-bold text-indigo-400 block uppercase">ទំហំ</span><input type="range" id="imgScale" min="0.1" max="10" step="0.01" class="w-full accent-indigo-600"></div>
                        <div class="space-y-1"><span class="text-[10px] font-bold text-indigo-400 block uppercase">បង្វិល</span><input type="range" id="imgRotation" min="-360" max="360" step="1" class="w-full accent-indigo-600"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1"><span class="text-[10px] font-bold text-indigo-400 block uppercase">ឆ្វេង-ស្តាំ</span><input type="range" id="imgPosX" min="-800" max="800" step="1" class="w-full accent-indigo-600"></div>
                        <div class="space-y-1"><span class="text-[10px] font-bold text-indigo-400 block uppercase">លើ-ក្រោម</span><input type="range" id="imgPosY" min="-800" max="800" step="1" class="w-full accent-indigo-600"></div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Shadows -->
            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 space-y-4">
                <label class="text-sm font-bold text-slate-700 uppercase flex items-center gap-2"><i class="fa-solid fa-arrows-up-down"></i> ស្រមោលរូបភាព</label>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1"><span class="text-[10px] font-bold text-slate-400 block uppercase">ទីតាំង X</span><input type="range" id="shadowX" min="-200" max="200" class="w-full accent-slate-600"></div>
                    <div class="space-y-1"><span class="text-[10px] font-bold text-slate-400 block uppercase">ទីតាំង Y</span><input type="range" id="shadowY" min="-100" max="200" class="w-full accent-slate-600"></div>
                </div>
                <div class="grid grid-cols-3 gap-4 border-t pt-2">
                    <div class="space-y-1"><span class="text-[10px] font-bold text-slate-400 block uppercase">Blur</span><input type="range" id="shadowBlur" min="0" max="100" class="w-full accent-slate-600"></div>
                    <div class="space-y-1"><span class="text-[10px] font-bold text-slate-400 block uppercase">ច្បាស់</span><input type="range" id="shadowOpacity" min="0" max="1" step="0.05" class="w-full accent-slate-600"></div>
                    <div class="space-y-1"><span class="text-[10px] font-bold text-slate-400 block uppercase">ទំហំ</span><input type="range" id="shadowWidth" min="10" max="1000" class="w-full accent-slate-600"></div>
                </div>
            </div>

            <!-- Weight Input Section -->
            <div class="bg-rose-50 p-4 rounded-2xl border border-rose-200 space-y-4">
                <label class="text-sm font-bold text-rose-700 uppercase flex items-center gap-2"><i class="fa-solid fa-weight-hanging"></i> បញ្ចូលទម្ងន់</label>
                <div class="flex gap-1 mb-2">
                    <button onclick="setWeightMode('kg')" id="btnKg" class="flex-1 py-1 text-[9px] font-bold rounded border bg-rose-600 text-white">KG</button>
                    <button onclick="setWeightMode('g')" id="btnG" class="flex-1 py-1 text-[9px] font-bold rounded border bg-white text-rose-600">G</button>
                    <button onclick="setWeightMode('kgg')" id="btnKgg" class="flex-1 py-1 text-[9px] font-bold rounded border bg-white text-rose-600">KG & G</button>
                </div>
                
                <div id="weightInputs" class="grid grid-cols-1 gap-2">
                    <div id="kgInputWrap" class="relative">
                        <input type="number" id="inputKg" placeholder="0" class="w-full p-2 pr-8 border rounded-xl font-bold text-sm focus:ring-2 focus:ring-rose-400 outline-none">
                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-slate-400">kg</span>
                    </div>
                    <div id="gInputWrap" class="relative hidden">
                        <input type="number" id="inputG" placeholder="0" class="w-full p-2 pr-6 border rounded-xl font-bold text-sm focus:ring-2 focus:ring-rose-400 outline-none">
                        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-slate-400">g</span>
                    </div>
                </div>
            </div>

            <!-- Dial Adjustment -->
            <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-200 space-y-3">
                <label class="text-xs font-bold text-emerald-700 uppercase flex items-center gap-2"><i class="fa-solid fa-sliders"></i> សារ៉េម្ជុល</label>
                <input type="range" id="userAdjustment" class="w-full accent-emerald-600">
            </div>

            <button onclick="downloadImage()" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-bold shadow-lg hover:bg-black flex items-center justify-center gap-2 uppercase transition-all active:scale-95">
                <i class="fa-solid fa-download"></i> ទាញយក PNG (8K Support)
            </button>
        </div>

        <!-- Preview Area -->
        <div class="flex-1 flex items-center justify-center p-6 bg-slate-200 overflow-hidden min-h-[600px]">
            <div class="bg-white p-4 rounded-[3rem] shadow-2xl border-[16px] border-slate-50 relative overflow-auto max-h-[90vh] max-w-full custom-scrollbar">
                <canvas id="scaleCanvas" style="width: 400px; height: 500px; background: #fff;"></canvas>
                <div class="absolute top-2 right-4 text-[10px] font-mono text-slate-300">HQ 8K Upscale View</div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration & Constants ---
        const scaleConfigs = {
            '1kg_g':   { max: 1000,   unit: 'g',  label: '1kg',   major: 100,  step: 10,  baseOffset: 251,   adjRange: 500 },
            '2kg_g':   { max: 2000,   unit: 'g',  label: '2kg',   major: 200,  step: 20,  baseOffset: -1497, adjRange: 1000 },
            '5kg_g':   { max: 5000,   unit: 'g',  label: '5kg',   major: 500,  step: 50,  baseOffset: 1255,  adjRange: 2000 },
            '10kg_g':  { max: 10000,  unit: 'g',  label: '10kg',  major: 1000, step: 100, baseOffset: 2515,  adjRange: 3000 },
            '10kg_kg': { max: 10000,  unit: 'kg', label: '10kg',  major: 1000, step: 100, baseOffset: 2505,  adjRange: 3000 },
            '15kg_kg': { max: 15000,  unit: 'kg', label: '15kg',  major: 1000, step: 100, baseOffset: 3757,  adjRange: 4000 },
            '50kg_kg': { max: 50000,  unit: 'kg', label: '50kg',  major: 5000, step: 500, baseOffset: 12577, adjRange: 10000 },
            '100kg_kg':{ max: 100000, unit: 'kg', label: '100kg', major: 10000,step: 1000,baseOffset: 25000, adjRange: 20000 },
            '150kg_kg':{ max: 150000, unit: 'kg', label: '150kg', major: 10000,step: 1000,baseOffset: 37670, adjRange: 30000 },
        };

        const colors = [
            '#008b8b', '#064e3b', '#10b981', '#84cc16', '#b8860b', '#eab308',
            '#f97316', '#b91c1c', '#e11d48', '#db2777', '#7e22ce', '#4338ca',
            '#1d4ed8', '#0ea5e9', '#06b6d4', '#475569', '#0f172a', '#78350f'
        ];

        const trayColors = [
            '#e2e8f0', '#94a3b8', '#64748b', '#3f3f46', '#ffffff', '#fef3c7',
            '#fbbf24', '#cbd5e1', '#18181b', '#52525b'
        ];

        const designStyles = [
            { id: 'classic', name: 'ម៉ូដបុរាណ (Classic)' },
            { id: 'modern', name: 'ម៉ូដទំនើប (Modern Square)' },
            { id: 'rounded', name: 'ម៉ូដរាងមូល (Full Circle)' },
            { id: 'trapezoid', name: 'ម៉ូដរាងព្នាយ (Trapezoid)' },
            { id: 'industrial', name: 'ម៉ូដធុនធ្ងន់ (Industrial)' },
            { id: 'curvy', name: 'ម៉ូដរាងកោង (Curvy Elegant)' },
            { id: 'diamond', name: 'ម៉ូដរាងពេជ្រ (Diamond Cut)' }
        ];

        const trayStyles = [
            { id: 'oval_classic', name: 'ពងក្រពើ-គែមក្រាស់' },
            { id: 'oval_deep', name: 'ពងក្រពើ-រាងជ្រៅ' },
            { id: 'oval_flat', name: 'ពងក្រពើ-រាបស្មើ' },
            { id: 'oval_luxury', name: 'ពងក្រពើ-មាសប្រណីត' },
            { id: 'oval_industrial', name: 'ពងក្រពើ-ដែកស្ទប' },
            { id: 'square', name: 'ចានរាងការ៉េ' }
        ];

        // --- State Variables ---
        let currentScaleType = '15kg_kg';
        let currentDesignStyle = 'classic';
        let currentTrayStyle = 'oval_classic';
        let currentScaleColor = '#008b8b';
        let currentDialBorderColor = '#94a3b8';
        let currentTrayColor = '#cbd5e1';

        let images = [];
        let selectedImgIndex = null;
        let weightMode = 'kg';
        let inputKgValue = 0;
        let inputGValue = 0;
        let userAdjustmentValue = 0;
        let animateOffset = 0;

        let shadowXVal = 0;
        let shadowYVal = 2;
        let shadowBlurVal = 6;
        let shadowOpacityVal = 0.35;
        let shadowWidthVal = 180;

        // NEW: Flag for export mode
        let isExporting = false;

        // --- DOM Elements ---
        const canvas = document.getElementById('scaleCanvas');
        const ctx = canvas.getContext('2d');

        // --- Initialization ---
        function initUI() {
            const stSelect = document.getElementById('scaleType');
            Object.keys(scaleConfigs).forEach(key => {
                const opt = new Option(`${scaleConfigs[key].label} (${scaleConfigs[key].unit})`, key);
                stSelect.add(opt);
            });
            stSelect.value = currentScaleType;

            const dsSelect = document.getElementById('designStyle');
            designStyles.forEach(s => dsSelect.add(new Option(s.name, s.id)));
            dsSelect.value = currentDesignStyle;

            const tsSelect = document.getElementById('trayStyle');
            trayStyles.forEach(t => tsSelect.add(new Option(t.name, t.id)));
            tsSelect.value = currentTrayStyle;

            const createPalette = (containerId, colorsArr, onClick) => {
                const container = document.getElementById(containerId);
                colorsArr.forEach(c => {
                    const btn = document.createElement('button');
                    btn.className = 'w-4 h-4 rounded-full border border-gray-300 transition-transform active:scale-90';
                    btn.style.backgroundColor = c;
                    btn.onclick = () => onClick(c, btn);
                    container.appendChild(btn);
                });
            };

            createPalette('scaleColors', colors, (c) => { currentScaleColor = c; drawScale(); });
            createPalette('dialBorderColors', colors.slice().reverse(), (c) => { currentDialBorderColor = c; drawScale(); });
            createPalette('trayColors', trayColors, (c) => { currentTrayColor = c; drawScale(); });

            stSelect.onchange = (e) => { currentScaleType = e.target.value; updateAdjustmentRange(); drawScale(); };
            dsSelect.onchange = (e) => { currentDesignStyle = e.target.value; drawScale(); };
            tsSelect.onchange = (e) => { currentTrayStyle = e.target.value; drawScale(); };
            
            document.getElementById('inputKg').oninput = (e) => { inputKgValue = parseFloat(e.target.value) || 0; drawScale(); };
            document.getElementById('inputG').oninput = (e) => { inputGValue = parseFloat(e.target.value) || 0; drawScale(); };
            document.getElementById('userAdjustment').oninput = (e) => { userAdjustmentValue = parseFloat(e.target.value); drawScale(); };
            
            document.getElementById('imgScale').oninput = (e) => updateImg('scale', parseFloat(e.target.value));
            document.getElementById('imgRotation').oninput = (e) => updateImg('rotation', parseInt(e.target.value));
            document.getElementById('imgPosX').oninput = (e) => updateImg('posX', parseInt(e.target.value));
            document.getElementById('imgPosY').oninput = (e) => updateImg('posY', parseInt(e.target.value));

            document.getElementById('shadowX').oninput = (e) => { shadowXVal = parseInt(e.target.value); drawScale(); };
            document.getElementById('shadowY').oninput = (e) => { shadowYVal = parseInt(e.target.value); drawScale(); };
            document.getElementById('shadowBlur').oninput = (e) => { shadowBlurVal = parseInt(e.target.value); drawScale(); };
            document.getElementById('shadowOpacity').oninput = (e) => { shadowOpacityVal = parseFloat(e.target.value); drawScale(); };
            document.getElementById('shadowWidth').oninput = (e) => { shadowWidthVal = parseInt(e.target.value); drawScale(); };

            updateAdjustmentRange();
            animate();
        }

        function updateAdjustmentRange() {
            const adj = document.getElementById('userAdjustment');
            const config = scaleConfigs[currentScaleType];
            adj.min = -config.adjRange;
            adj.max = config.adjRange;
            adj.value = 0;
            userAdjustmentValue = 0;
        }

        function setWeightMode(mode) {
            weightMode = mode;
            const btnKg = document.getElementById('btnKg');
            const btnG = document.getElementById('btnG');
            const btnKgg = document.getElementById('btnKgg');
            const kgW = document.getElementById('kgInputWrap');
            const gW = document.getElementById('gInputWrap');
            const wInputs = document.getElementById('weightInputs');

            [btnKg, btnG, btnKgg].forEach(b => b.classList.replace('bg-rose-600', 'bg-white'));
            [btnKg, btnG, btnKgg].forEach(b => b.classList.replace('text-white', 'text-rose-600'));

            if(mode === 'kg') {
                btnKg.classList.replace('bg-white', 'bg-rose-600');
                btnKg.classList.replace('text-rose-600', 'text-white');
                kgW.classList.remove('hidden'); gW.classList.add('hidden');
                wInputs.classList.replace('grid-cols-2', 'grid-cols-1');
            } else if(mode === 'g') {
                btnG.classList.replace('bg-white', 'bg-rose-600');
                btnG.classList.replace('text-rose-600', 'text-white');
                kgW.classList.add('hidden'); gW.classList.remove('hidden');
                wInputs.classList.replace('grid-cols-2', 'grid-cols-1');
            } else {
                btnKgg.classList.replace('bg-white', 'bg-rose-600');
                btnKgg.classList.replace('text-rose-600', 'text-white');
                kgW.classList.remove('hidden'); gW.classList.remove('hidden');
                wInputs.classList.replace('grid-cols-1', 'grid-cols-2');
            }
            drawScale();
        }

        function shadeColor(color, percent) {
            let R = parseInt(color.substring(1,3),16);
            let G = parseInt(color.substring(3,5),16);
            let B = parseInt(color.substring(5,7),16);
            R = parseInt(R * (100 + percent) / 100); G = parseInt(G * (100 + percent) / 100); B = parseInt(B * (100 + percent) / 100);
            R = (R<255)?R:255; G = (G<255)?G:255; B = (B<255)?B:255;
            let RR = ((R.toString(16).length===1)?"0"+R.toString(16):R.toString(16));
            let GG = ((G.toString(16).length===1)?"0"+G.toString(16):G.toString(16));
            let BB = ((B.toString(16).length===1)?"0"+B.toString(16):B.toString(16));
            return "#"+RR+GG+BB;
        }

        function drawScale() {
            const config = scaleConfigs[currentScaleType];
            let testWeight = 0;
            if (weightMode === 'kg') testWeight = inputKgValue * 1000;
            else if (weightMode === 'g') testWeight = inputGValue;
            else testWeight = (inputKgValue * 1000) + inputGValue;

            const totalWeight = config.baseOffset + userAdjustmentValue + testWeight;
            const maxWeight = config.max;

            const width = 800, height = 1000;
            canvas.width = width; canvas.height = height;
            ctx.clearRect(0, 0, width, height);

            const centerX = width / 2;
            const bodyBaseY = 450, bodyBottomY = 780, dialCenterY = 625;
            let dialRadius = currentDesignStyle === 'diamond' ? 105 : 140;
            const trayTopY = bodyBaseY - 85;

            // Support Rods
            ctx.strokeStyle = shadeColor(currentScaleColor, -25);
            ctx.lineWidth = 14; ctx.lineCap = 'round';
            let sw = currentDesignStyle === 'diamond' ? 22 : 60;
            let ssy = currentDesignStyle === 'diamond' ? bodyBaseY + 50 : bodyBaseY + 20;
            ctx.beginPath(); ctx.moveTo(centerX - sw, ssy); ctx.lineTo(centerX - sw, trayTopY + 25); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(centerX + sw, ssy); ctx.lineTo(centerX + sw, trayTopY + 25); ctx.stroke();

            // Scale Body
            ctx.fillStyle = currentScaleColor;
            ctx.beginPath();
            switch(currentDesignStyle) {
                case 'classic': ctx.moveTo(centerX - 90, bodyBaseY + 20); ctx.lineTo(centerX + 90, bodyBaseY + 20); ctx.lineTo(centerX + 140, bodyBottomY); ctx.lineTo(centerX - 140, bodyBottomY); break;
                case 'modern': ctx.roundRect(centerX - 120, bodyBaseY + 20, 240, bodyBottomY - bodyBaseY - 20, 25); break;
                case 'rounded': ctx.arc(centerX, dialCenterY, 175, 0, Math.PI * 2); break;
                case 'trapezoid': ctx.moveTo(centerX - 120, bodyBaseY + 20); ctx.lineTo(centerX + 120, bodyBaseY + 20); ctx.lineTo(centerX + 80, bodyBottomY); ctx.lineTo(centerX - 80, bodyBottomY); break;
                case 'industrial': ctx.roundRect(centerX - 140, bodyBaseY + 20, 280, bodyBottomY - bodyBaseY - 20, 8); break;
                case 'curvy': ctx.moveTo(centerX - 70, bodyBaseY + 20); ctx.bezierCurveTo(centerX - 150, 540, centerX - 150, 720, centerX - 120, bodyBottomY); ctx.lineTo(centerX + 120, bodyBottomY); ctx.bezierCurveTo(centerX + 150, 720, centerX + 150, 540, centerX + 70, bodyBaseY + 20); break;
                case 'diamond': ctx.moveTo(centerX, bodyBaseY + 10); ctx.lineTo(centerX + 175, dialCenterY); ctx.lineTo(centerX, bodyBottomY + 30); ctx.lineTo(centerX - 175, dialCenterY); break;
                default: ctx.roundRect(centerX - 120, bodyBaseY + 20, 240, bodyBottomY - bodyBaseY - 20, 15);
            }
            ctx.closePath(); ctx.fill();
            ctx.strokeStyle = 'rgba(0,0,0,0.15)'; ctx.lineWidth = 2; ctx.stroke();

            // Feet & Knob
            ctx.fillStyle = shadeColor(currentScaleColor, -45);
            ctx.beginPath(); ctx.roundRect(centerX - 155, bodyBottomY - 5, 310, 40, 10); ctx.fill();

            let knobY = currentDesignStyle === 'diamond' ? bodyBaseY + 88 : (currentDesignStyle === 'rounded' ? dialCenterY - 170 : bodyBaseY + 22);
            ctx.fillStyle = '#1e293b'; ctx.beginPath(); ctx.roundRect(centerX - 28, knobY - 16, 56, 16, 4); ctx.fill();

            // 3D Tray
            ctx.save(); ctx.translate(centerX, trayTopY);
            const drawOval3D = (w, h, depth, rimWidth, isLuxury = false) => {
                ctx.fillStyle = shadeColor(currentTrayColor, -45); ctx.beginPath(); ctx.ellipse(0, depth + 5, w, h, 0, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = shadeColor(currentTrayColor, -30);
                for(let i=0; i<depth; i++) { ctx.beginPath(); ctx.ellipse(0, i, w, h, 0, 0, Math.PI * 2); ctx.fill(); }
                const surfGrad = ctx.createRadialGradient(0, -h/2, 10, 0, 0, w); surfGrad.addColorStop(0, shadeColor(currentTrayColor, 20)); surfGrad.addColorStop(1, currentTrayColor);
                ctx.fillStyle = surfGrad; ctx.beginPath(); ctx.ellipse(0, 0, w, h, 0, 0, Math.PI * 2); ctx.fill();
                if (rimWidth > 0) { ctx.strokeStyle = isLuxury ? '#fbbf24' : shadeColor(currentTrayColor, -15); ctx.lineWidth = rimWidth; ctx.beginPath(); ctx.ellipse(0, 0, w - rimWidth/2, h - rimWidth/2, 0, 0, Math.PI * 2); ctx.stroke(); }
            };

            switch(currentTrayStyle) {
                case 'oval_classic': drawOval3D(175, 45, 12, 8); break;
                case 'oval_deep': drawOval3D(170, 55, 18, 4); break;
                case 'oval_flat': drawOval3D(185, 35, 6, 2); break;
                case 'oval_luxury': drawOval3D(175, 48, 14, 6, true); break;
                case 'oval_industrial': drawOval3D(180, 50, 20, 10); break;
                case 'square': ctx.fillStyle = shadeColor(currentTrayColor, -30); ctx.roundRect(-160, 5, 320, 25, 8); ctx.fill(); ctx.fillStyle = currentTrayColor; ctx.roundRect(-160, -10, 320, 20, 8); ctx.fill(); break;
            }

            if (images.length > 0) {
                ctx.save(); ctx.globalCompositeOperation = 'source-atop'; ctx.translate(shadowXVal, shadowYVal); ctx.scale(1, 0.2); 
                ctx.beginPath(); ctx.ellipse(0, 0, shadowWidthVal / 2, shadowWidthVal / 4, 0, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(0,0,0,${shadowOpacityVal})`; ctx.filter = `blur(${shadowBlurVal}px)`; ctx.fill(); ctx.restore();
            }
            ctx.restore();

            // Dial
            ctx.save(); ctx.translate(centerX, dialCenterY);
            ctx.beginPath(); ctx.arc(0, 0, dialRadius + 10, 0, Math.PI * 2); ctx.fillStyle = currentDialBorderColor; ctx.fill();
            ctx.beginPath(); ctx.arc(0, 0, dialRadius, 0, Math.PI * 2); ctx.fillStyle = '#fff'; ctx.fill();

            const outerR = dialRadius - 8;
            for (let i = 0; i <= maxWeight; i += config.step) {
                const angle = (i / maxWeight) * (Math.PI * 2) - (Math.PI / 2);
                const isMajor = i % config.major === 0;
                ctx.beginPath();
                let itR = isMajor ? dialRadius - 28 : dialRadius - 14;
                ctx.moveTo(Math.cos(angle) * outerR, Math.sin(angle) * outerR); ctx.lineTo(Math.cos(angle) * itR, Math.sin(angle) * itR);
                ctx.strokeStyle = isMajor ? '#000' : '#64748b'; ctx.lineWidth = isMajor ? 3 : 1; ctx.stroke();
                if (isMajor && i < maxWeight) {
                    ctx.save(); ctx.fillStyle = i===0?'#e11d48':'#1e293b'; ctx.font = `bold ${dialRadius<115?14:18}px Arial`;
                    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillText((config.unit==='kg'?i/1000:i).toString(), Math.cos(angle)*(dialRadius-48), Math.sin(angle)*(dialRadius-48)); ctx.restore();
                }
            }

            ctx.fillStyle = '#64748b'; ctx.font = `bold ${dialRadius<115?16:22}px Arial`; ctx.textAlign='center'; ctx.textBaseline='middle';
            ctx.fillText(config.label, 0, -dialRadius * 0.35);

            const nAngle = (totalWeight / maxWeight) * (Math.PI * 2) - (Math.PI / 2);
            ctx.save(); ctx.rotate(nAngle); ctx.shadowBlur = 4; ctx.shadowColor = 'rgba(0,0,0,0.3)';
            ctx.fillStyle = '#ff0000'; ctx.beginPath(); ctx.moveTo(-4, 20); ctx.lineTo(-1, -(dialRadius-20)); ctx.lineTo(1, -(dialRadius-20)); ctx.lineTo(4, 20); ctx.fill();
            ctx.shadowBlur = 0; ctx.fillStyle = '#334155'; ctx.beginPath(); ctx.arc(0, 0, 12, 0, Math.PI * 2); ctx.fill();
            ctx.restore(); ctx.restore();

            // Images with Selection Border Logic
            images.forEach((img, idx) => {
                ctx.save(); const bs = 180; const w = bs * img.scale; const h = (bs * (img.element.height/img.element.width)) * img.scale;
                ctx.translate(centerX + img.posX, trayTopY + img.posY - 10); ctx.rotate(img.rotation*(Math.PI/180) + animateOffset);
                
                // FIXED: Only draw border if we ARE NOT exporting
                if(!isExporting && idx === selectedImgIndex) { 
                    ctx.strokeStyle = 'rgba(20, 184, 166, 0.7)'; 
                    ctx.lineWidth = 3; 
                    ctx.strokeRect(-w/2-2, -h-2, w+4, h+4); 
                }
                
                ctx.drawImage(img.element, -w/2, -h, w, h); ctx.restore();
            });
        }

        function animate() {
            if(!isExporting) {
                animateOffset = Math.sin(Date.now() * 0.002) * 0.015;
                drawScale();
                requestAnimationFrame(animate);
            }
        }

        document.getElementById('fileInput').onchange = function(e) {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.onload = () => {
                        images.push({ element: img, scale: 0.8, rotation: 0, posX: 0, posY: 0 });
                        selectImage(images.length - 1);
                        renderThumbnails();
                    };
                    img.src = ev.target.result;
                };
                reader.readAsDataURL(file);
            }
        };

        function renderThumbnails() {
            const container = document.getElementById('imageThumbnails');
            container.innerHTML = '';
            images.forEach((img, idx) => {
                const btn = document.createElement('button');
                btn.className = `flex-shrink-0 w-10 h-10 rounded-lg border-2 overflow-hidden bg-white ${selectedImgIndex === idx ? 'border-teal-500' : 'border-slate-200'}`;
                btn.innerHTML = `<img src="${img.element.src}" class="w-full h-full object-cover">`;
                btn.onclick = () => selectImage(idx);
                container.appendChild(btn);
            });
        }

        function selectImage(idx) {
            selectedImgIndex = idx;
            const controls = document.getElementById('imageControls');
            if(idx !== null) {
                controls.classList.remove('hidden');
                document.getElementById('selectedImageLabel').innerText = `កែរូបភាព ${idx + 1}`;
                const img = images[idx];
                document.getElementById('imgScale').value = img.scale;
                document.getElementById('imgRotation').value = img.rotation;
                document.getElementById('imgPosX').value = img.posX;
                document.getElementById('imgPosY').value = img.posY;
            } else {
                controls.classList.add('hidden');
            }
            renderThumbnails();
            drawScale();
        }

        function updateImg(key, val) {
            if(selectedImgIndex === null) return;
            images[selectedImgIndex][key] = val;
            drawScale();
        }

        function deleteSelectedImage() {
            if(selectedImgIndex === null) return;
            images.splice(selectedImgIndex, 1);
            selectImage(null);
            renderThumbnails();
            drawScale();
        }

        function downloadImage() {
            // Step 1: Set exporting flag to true to hide the selection box
            isExporting = true;
            
            // Step 2: Redraw canvas without the selection box
            drawScale();
            
            // Step 3: Trigger download
            const link = document.createElement('a');
            link.download = `scale_design_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
            
            // Step 4: Turn off export mode and restart animation
            isExporting = false;
            requestAnimationFrame(animate);
        }

        window.onload = initUI;
    </script>
</body>
</html>