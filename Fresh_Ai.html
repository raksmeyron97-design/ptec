<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard AI Pro - Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;700&family=Moul&family=Dangrek&family=Koulen&family=Siemreap&family=Hanuman&family=Chenla&family=Bayon&family=Bokor&family=Freehand&family=Metal&family=Odor+Mean+Chey&family=Preahvihear&family=Taprom&family=Fascinate&family=Kamma&family=Koh+Santepheap&family=Moulpali&family=Suwannaphum&family=Fasthand&family=Content&family=Khmer&family=Nokora&family=Battambang&family=Angkor&family=Chivo&display=swap" rel="stylesheet">
    <style>
        :root { --primary-font: 'Kantumruy Pro', sans-serif; }
        body { font-family: var(--primary-font); background: #f8fafc; margin: 0; padding: 0; }
        
        /* Layout Definitions */
        .paper-a4.portrait { width: 210mm; height: 297mm; }
        .paper-a4.landscape { width: 297mm; height: 210mm; }
        .paper-a3.portrait { width: 297mm; height: 420mm; }
        .paper-a3.landscape { width: 420mm; height: 297mm; }
        .paper-a5.portrait { width: 148mm; height: 210mm; }
        .paper-a5.landscape { width: 210mm; height: 148mm; }

        @media print {
            body { background: white !important; }
            .no-print { display: none !important; } 
            #mainContainer { padding: 0 !important; margin: 0 !important; }
            #paperAreaWrapper { transform: none !important; width: 100% !important; margin: 0 !important; }
            .flashcard-container { box-shadow: none !important; page-break-after: always !important; }
        }

        .flashcard-container {
            display: flex; align-items: center; justify-content: center; background: white;
            position: relative; overflow: hidden; flex-shrink: 0;
        }

        .flashcard { position: absolute; width: 92%; height: 92%; box-sizing: border-box; pointer-events: none; z-index: 10; }
        
        /* Border Styles */
        .f-solid-1 { border: 2px solid; } .f-solid-2 { border: 6px solid; } .f-solid-3 { border: 12px solid; }
        .f-double-1 { border: 6px double; } .f-double-2 { border: 12px double; }
        .f-dash-1 { border: 4px dashed; } .f-dash-2 { border: 8px dashed; }
        .f-dot-1 { border: 4px dotted; } .f-dot-2 { border: 8px dotted; }
        .f-round-1 { border: 6px solid; border-radius: 20px; } .f-round-2 { border: 6px solid; border-radius: 50px; }
        .f-pill { border: 6px solid; border-radius: 999px; } .f-circle { border: 6px solid; border-radius: 50%; }
        .f-groove { border: 12px groove; } .f-ridge { border: 12px ridge; } .f-inset { border: 12px inset; } .f-outset { border: 12px outset; }
        .f-shadow-1 { border: 2px solid; box-shadow: 8px 8px 0px; } .f-shadow-2 { border: 2px solid; box-shadow: -8px 8px 0px; }
        .f-neon { border: 4px solid; box-shadow: 0 0 15px; } .f-dual { border: 4px solid; outline: 4px solid; outline-offset: 4px; }

        .draggable { position: absolute; cursor: move; user-select: none; pointer-events: auto; }
        .image-container { width: 80%; height: 60%; display: flex; align-items: center; justify-content: center; z-index: 5; }
        .image-container img { max-width: 100%; max-height: 100%; object-fit: contain; background: white; }
        .text-container { width: 100%; text-align: center; z-index: 15; }

        /* Robot Animations */
        @keyframes bodyFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes eyeScan { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(5px); } }
        @keyframes antennaPulse { 0%, 100% { opacity: 1; filter: drop-shadow(0 0 2px gold); } 50% { opacity: 0.5; filter: drop-shadow(0 0 8px gold); } }
        
        .robot-floating { animation: bodyFloat 3s ease-in-out infinite; }
        .robot-eye-move { animation: eyeScan 2s ease-in-out infinite; }
        .antenna-light { animation: antennaPulse 1.5s infinite; }

        .app-logo-bg {
            width: 60px; height: 60px; background: linear-gradient(135deg, #fbbf24, #d97706);
            border-radius: 16px; position: relative; display: flex; align-items: center; justify-content: center;
            border: 2px solid rgba(255,255,255,0.5); box-shadow: 0 8px 20px rgba(217, 119, 6, 0.3);
        }

        .regen-btn {
            position: absolute; top: 15px; right: 15px; z-index: 100; background: #6366f1;
            color: white; padding: 5px 10px; border-radius: 15px; font-size: 9px; font-weight: bold;
            display: none; cursor: pointer; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .manual-btn-group {
            position: absolute; top: 15px; right: 15px; z-index: 100; display: none; gap: 5px;
        }

        .flashcard-container:hover .regen-btn, 
        .flashcard-container:hover .manual-btn-group { display: flex; }
        
        /* Manual Upload Styles */
        .upload-placeholder {
            width: 100px; height: 100px; border: 3px dashed #cbd5e1; border-radius: 15px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #94a3b8; cursor: pointer; transition: all 0.2s;
        }
        .upload-placeholder:hover { border-color: #6366f1; color: #6366f1; background: #eef2ff; }

        #paperAreaWrapper { transform-origin: top center; transition: transform 0.2s; }
    </style>
</head>
<body class="flex flex-col lg:flex-row h-screen overflow-hidden">

    <aside class="no-print w-full lg:w-[420px] bg-white p-6 overflow-y-auto h-[40vh] lg:h-full z-30 shadow-2xl border-r border-slate-200">
        <div class="flex items-center gap-4 mb-6">
            <div class="app-logo-bg">
                <svg viewBox="0 0 100 100" class="w-12 h-12 robot-floating">
                    <rect x="25" y="35" width="50" height="45" rx="10" fill="#FFFBEB" stroke="#B45309" stroke-width="2"/>
                    <circle cx="40" cy="55" r="5" fill="#10b981" class="robot-eye-move"/>
                    <circle cx="60" cy="55" r="5" fill="#10b981" class="robot-eye-move"/>
                    <line x1="50" y1="35" x2="50" y2="15" stroke="#B45309" stroke-width="3"/>
                    <circle cx="50" cy="15" r="6" fill="#fbbf24" class="antenna-light"/>
                    <rect x="40" y="70" width="20" height="3" rx="1.5" fill="#4B5563"/>
                </svg>
            </div>
            <div>
                <h1 class="text-xl font-bold font-moul text-slate-800 leading-tight">Flashcard AI Pro</h1>
                <p class="text-[9px] text-amber-600 font-black uppercase tracking-[0.2em]">Ultimate v4.0 â€¢ 100+ Styles</p>
            </div>
        </div>

        <div class="mb-6 p-4 bg-indigo-50 rounded-2xl border border-indigo-100 shadow-sm">
            <label class="text-[10px] font-black text-indigo-600 mb-2 block uppercase">á‡á˜áŸ’ášá¾áŸáŠá¶á€áŸ‹ášá¼á”á—á¶á– (Image Source)</label>
            <select id="sourceMode" onchange="updateUI()" class="w-full p-2.5 bg-white border border-indigo-200 rounded-xl text-xs font-bold outline-none text-indigo-700">
                <option value="ai">ğŸ¤– Option 1: AI Generator (á”áŸ’ášá¾ AI)</option>
                <option value="manual">ğŸ“‚ Option 2: Upload á•áŸ’á‘á¶á›áŸ‹ááŸ’á›á½á“ (áŠá¶á€áŸ‹ášá¼á”ááŸ’á›á½á“á¯á„)</option>
            </select>
        </div>

        <div id="apiKeySection" class="mb-6 p-4 bg-amber-50 rounded-2xl border border-amber-100 shadow-inner">
            <label class="text-[10px] font-black text-amber-600 mb-2 block uppercase">Gemini API Key (á•áŸ’á‘á¶á›áŸ‹ááŸ’á›á½á“)</label>
            <div class="relative">
                <input type="password" id="customApiKey" placeholder="á”á‰áŸ’á…á¼á› API Key ášá”áŸáŸ‹á¢áŸ’á“á€á“áŸ…á‘á¸á“áŸáŸ‡..." 
                    class="w-full p-2.5 bg-white border border-amber-200 rounded-xl text-xs font-mono outline-none focus:ring-2 focus:ring-amber-400">
                <button onclick="toggleApiKeyVisibility()" class="absolute right-3 top-2 text-amber-400">ğŸ‘ï¸</button>
            </div>
            <p class="text-[9px] text-amber-500 mt-2 italic">* á”áŸ’ášáŸá·á“á”á¾á˜á·á“áŠá¶á€áŸ‹ áœá¶á“á¹á„á”áŸ’ášá¾ Key ášá½á˜ (á¢á¶á…á‚á¶áŸ†á„á”á¾á”áŸ’ášá¾á…áŸ’ášá¾á“)áŸ”</p>
        </div>

        <div class="space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <section>
                    <label class="text-[10px] font-black text-slate-400 mb-1.5 block uppercase">á‘áŸ†á áŸ†á€áŸ’ášáŠá¶áŸ</label>
                    <select id="pageSize" onchange="updateUI()" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold outline-none">
                        <option value="paper-a4">A4 Standard</option>
                        <option value="paper-a3">A3 Large</option>
                        <option value="paper-a5">A5 Small</option>
                    </select>
                </section>
                <section>
                    <label class="text-[10px] font-black text-slate-400 mb-1.5 block uppercase">á‘á·áŸáŠáŸ…</label>
                    <select id="orientation" onchange="updateUI()" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold outline-none">
                        <option value="portrait">á”á‰áŸ’áˆáš (Portrait)</option>
                        <option value="landscape">á•áŸ’áŠáŸá€ (Landscape)</option>
                    </select>
                </section>
            </div>

            <section>
                <label class="text-[10px] font-black text-slate-400 mb-1.5 block uppercase">ášá…á“á¶á”áŸá‘áŸ’á˜áŸáŸŠá»á˜</label>
                <select id="frameStyle" onchange="updateUI()" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl text-[11px] font-bold outline-none">
                    <optgroup label="áŸáŸŠá»á˜á˜á¼á›áŠáŸ’á‹á¶á“">
                        <option value="f-solid-1">áŸáŸŠá»á˜áŸáŸ’áá¾á„</option>
                        <option value="f-solid-2" selected>áŸáŸŠá»á˜á˜á’áŸ’á™á˜</option>
                        <option value="f-solid-3">áŸáŸŠá»á˜á€áŸ’ášá¶áŸáŸ‹</option>
                        <option value="f-double-2">áŸáŸŠá»á˜áŒá»á”</option>
                    </optgroup>
                    <optgroup label="áŸáŸŠá»á˜áŸá·á›áŸ’á”áŸˆ">
                        <option value="f-dash-2">á”á“áŸ’á‘á¶ááŸ‹áŠá¶á…áŸ‹áŸ—</option>
                        <option value="f-dot-2">á”á“áŸ’á‘á¶ááŸ‹á…á»á…áŸ—</option>
                        <option value="f-groove">áŸáŸŠá»á˜á•á (Groove)</option>
                        <option value="f-ridge">áŸáŸŠá»á˜á•á»áŸ (Ridge)</option>
                    </optgroup>
                    <optgroup label="áŸáŸŠá»á˜á‘áŸ†á“á¾á”">
                        <option value="f-round-2">áŸáŸŠá»á˜á˜á¼á›á‡áŸ’ášá»á„</option>
                        <option value="f-pill">áŸáŸŠá»á˜ášá¶á„ááŸ’á“á¶áŸ†á‚áŸ’ášá¶á”áŸ‹</option>
                        <option value="f-neon">áŸáŸŠá»á˜á–á“áŸ’á›áº (Neon)</option>
                        <option value="f-dual">áŸáŸŠá»á˜áŒá»á”áá¶á„á€áŸ’ášáŸ…</option>
                    </optgroup>
                </select>
            </section>

            <section id="aiStyleSection">
                <label class="text-[10px] font-black text-slate-400 mb-1.5 block uppercase">ášá…á“á¶á”áŸá‘áŸ’á˜ášá¼á”á—á¶á– AI (áŸ¥áŸ  áŸáŸ’á‘á¶á™)</label>
                <select id="imageStyle" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl text-[11px] font-bold outline-none">
                    <optgroup label="ášá¼á”á—á¶á–á–á·á (Realistic)">
                        <option value="High resolution macro photography, sharp focus, natural lighting, white background">ğŸ“¸ ášá¼á”á—á¶á–á–á·á (Macro Photo)</option>
                        <option value="Professional studio photography, soft shadows, 8k, white background">ğŸ“· ášá¼á”áá Studio</option>
                        <option value="National Geographic style nature photography, highly detailed, white background">ğŸŒ¿ ášá¼á”á—á¶á–á’á˜áŸ’á˜á‡á¶áá·á–á·á</option>
                        <option value="Vintage 35mm film photography, slight grain, white background">ğŸï¸ ášá¼á”á—á¶á–á áŸ’áœá¸á›á…á¶áŸáŸ‹áŸ—</option>
                        <option value="Hyper-realistic 3D render, octane render, trending on artstation, white background">ğŸ’ ášá¼á”á—á¶á– 3D á–á·ááŸ—</option>
                    </optgroup>
                    <optgroup label="áá»á€áŸ’á€áá¶ á“á·á„ á‚áŸ†á“á¼ášá‡á¸áœá…á› (Cartoon/Anime)">
                        <option value="3D cute pastel toy, Disney Pixar style, soft lighting, white background" selected>ğŸ¨ 3D Disney Pixar</option>
                        <option value="Studio Ghibli style anime illustration, hand-drawn, peaceful, white background">â›©ï¸ Studio Ghibli Style</option>
                        <option value="Classic 90s anime aesthetic, vibrant colors, white background">ğŸ“º Anime á†áŸ’á“á¶áŸ† áŸ©áŸ </option>
                        <option value="Kawaii chibbi style character, big eyes, adorable, white background">ğŸ§¸ á”áŸ‚á” Kawaii Chibi</option>
                        <option value="Saturday morning cartoon style, bold outlines, white background">ğŸ¬ á”áŸ‚á”áá»á€áŸ’á€áá¶á”á»ášá¶á</option>
                        <option value="Cocomelon style 3D animation, bright colors, friendly, white background">ğŸ‘¶ áŸáŸ’á‘á¶á™ Cocomelon</option>
                        <option value="Nickelodeon cartoon style, expressive, colorful, white background">ğŸ§¡ áŸáŸ’á‘á¶á™ Nickelodeon</option>
                        <option value="Japanese Manga black and white ink drawing, white background">ğŸ“– á‚áŸ†á“á¼áš Manga (áŸ-ááŸ’á˜áŸ…)</option>
                    </optgroup>
                    <optgroup label="áŸá·á›áŸ’á”áŸˆ á“á·á„ á‚áŸ†á“á¼ášáŠáŸƒ (Artistic)">
                        <option value="Vibrant watercolor painting, soft edges, splashes, white background">ğŸ–Œï¸ á–ááŸŒá‘á¹á€ (Watercolor)</option>
                        <option value="Impressionist oil painting, visible brushstrokes, Monet style, white background">ğŸ–¼ï¸ á‚áŸ†á“á¼ášá”áŸ’ášáŸá„ (Oil Painting)</option>
                        <option value="Detailed pencil sketch, hand-drawn, shading, white background">âœï¸ á‚áŸ†á“á¼ášááŸ’á˜áŸ…áŠáŸƒ (Sketch)</option>
                        <option value="Pop art style, Andy Warhol aesthetic, bold colors, white background">ğŸ¿ Pop Art</option>
                        <option value="Charcoal drawing, artistic textures, white background">ğŸŒ‘ á‚áŸ†á“á¼ášá’áŸ’á™á¼á„</option>
                    </optgroup>
                </select>
            </section>

            <section>
                <label class="text-[10px] font-black text-slate-400 mb-1.5 block uppercase">á–á»á˜áŸ’á–á¢á€áŸ’áŸáš</label>
                <select id="fontFamily" onchange="updateUI()" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl text-[11px] font-bold outline-none">
                    <option value="'Moul'">á¢á€áŸ’áŸášá˜á¼á›</option>
                    <option value="'Siemreap'">á¢á€áŸ’áŸášáŸáŸ€á˜ášá¶á”</option>
                    <option value="'Kantumruy Pro'">á€á“áŸ’áá»á˜ášá»á™ Pro</option>
                    <option value="'Dangrek'">áŠá„ášáŸ‚á€</option>
                </select>
            </section>

            <div class="bg-indigo-50 p-5 rounded-2xl space-y-5 border border-indigo-100">
                <div class="grid grid-cols-2 gap-4">
                    <section>
                        <label class="text-[9px] font-bold text-indigo-400 uppercase block mb-1">á‘áŸ†á áŸ†ášá¼á”</label>
                        <input type="range" id="globalImgScale" min="30" max="300" value="120" oninput="applyGlobalSettings()" class="w-full">
                    </section>
                    <section>
                        <label class="text-[9px] font-bold text-indigo-400 uppercase block mb-1">á‘áŸ†á áŸ†á¢á€áŸ’áŸáš</label>
                        <input type="range" id="globalTxtScale" min="50" max="800" value="350" oninput="applyGlobalSettings()" class="w-full">
                    </section>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <section>
                        <label class="text-[9px] font-bold text-indigo-400 uppercase block mb-1">á‘á¸áá¶áŸ†á„ášá¼á” (Y)</label>
                        <input type="range" id="globalImgY" min="-400" max="400" value="-60" oninput="applyGlobalSettings()" class="w-full">
                    </section>
                    <section>
                        <label class="text-[9px] font-bold text-indigo-400 uppercase block mb-1">á‘á¸áá¶áŸ†á„á¢á€áŸ’áŸáš (Y)</label>
                        <input type="range" id="globalTxtY" min="-400" max="600" value="250" oninput="applyGlobalSettings()" class="w-full">
                    </section>
                </div>
            </div>

            <section>
                <label class="block text-[10px] font-black text-slate-400 mb-1.5 uppercase">á”á‰áŸ’á‡á¸á–á¶á€áŸ’á™ (Tiger, Apple...)</label>
                <textarea id="wordInput" rows="3" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm font-bold focus:ring-2 focus:ring-indigo-400" oninput="updateUI()"></textarea>
            </section>

            <div class="flex gap-3">
                <div class="flex items-center gap-2 px-3.5 bg-white border border-slate-200 rounded-xl h-12 flex-1 shadow-sm">
                    <input type="color" id="mainColor" value="#1e40af" oninput="updateUI()" class="w-7 h-7 cursor-pointer border-none bg-transparent">
                    <label class="text-[10px] font-black text-slate-400 uppercase">á–ááŸŒ</label>
                </div>
                <button id="aiGenBtn" onclick="autoFillImages()" class="px-5 bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-xl font-bold text-xs shadow-xl transition-all transform active:scale-95 flex-1">âœ¨ á”á„áŸ’á€á¾áášá¼á”á—á¶á– AI</button>
            </div>

            <div class="pt-6 border-t border-slate-100 flex gap-3">
                <button onclick="downloadPDF()" class="flex-1 py-4 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-bold text-xs shadow-lg transition-all">ğŸ“¥ á‘á¶á‰á™á€ PDF</button>
                <button onclick="window.print()" class="px-6 py-4 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-2xl font-bold text-xs border border-slate-200">ğŸ–¨ï¸</button>
            </div>
        </div>
    </aside>

    <main id="mainContainer" class="flex-1 p-6 lg:p-12 overflow-auto bg-slate-100 flex justify-center items-start relative">
        <div id="paperAreaWrapper">
            <div id="paperArea" class="flex flex-col bg-white"></div>
        </div>
    </main>

    <div id="loadingToast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900/90 backdrop-blur-md text-white px-8 py-5 rounded-3xl hidden z-50 shadow-2xl items-center gap-4">
        <div class="w-6 h-6 border-3 border-amber-400 border-t-white rounded-full animate-spin"></div>
        <span id="loadingStatus" class="font-bold text-xs uppercase tracking-widest">á€áŸ†á–á»á„áŠáŸ†áá¾ášá€á¶ášáŠáŸ„á™ AI...</span>
    </div>

    <script>
        const fallbackApiKey = ""; 
        let cardData = {}; 
        let isGenerating = false;

        const robotWaitingSVG = `
        <svg viewBox="0 0 200 200" class="w-48 h-48 robot-floating opacity-50">
            <rect x="50" y="50" width="100" height="90" rx="20" fill="#FFFBEB" stroke="#fbbf24" stroke-width="2"/>
            <circle cx="80" cy="90" r="10" fill="#10b981" class="robot-eye-move"/>
            <circle cx="120" cy="90" r="10" fill="#10b981" class="robot-eye-move"/>
            <line x1="100" y1="50" x2="100" y2="20" stroke="#fbbf24" stroke-width="4" />
            <circle cx="100" cy="20" r="8" fill="#fbbf24" class="antenna-light" />
            <text x="100" y="175" text-anchor="middle" font-family="Kantumruy Pro" font-size="10" fill="#DAA520" font-weight="bold">ášá„áŸ‹á…á¶áŸ† AI...</text>
        </svg>`;

        function toggleApiKeyVisibility() {
            const input = document.getElementById('customApiKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function applyGlobalSettings() {
            const imgScale = parseInt(document.getElementById('globalImgScale').value);
            const txtScale = parseInt(document.getElementById('globalTxtScale').value);
            const imgY = parseInt(document.getElementById('globalImgY').value);
            const txtY = parseInt(document.getElementById('globalTxtY').value);
            Object.keys(cardData).forEach(word => {
                cardData[word].imgScale = imgScale;
                cardData[word].textScale = txtScale;
                cardData[word].imgPos.y = imgY;
                cardData[word].textPos.y = txtY;
            });
            updateUI();
        }

        function adjustScale() {
            const wrapper = document.getElementById('paperAreaWrapper');
            const main = document.getElementById('mainContainer');
            const card = document.querySelector('.flashcard-container');
            if (!card) return;
            const scale = Math.min((main.clientWidth - 60) / card.offsetWidth, 1);
            wrapper.style.transform = `scale(${scale})`;
            const cards = document.querySelectorAll('.flashcard-container');
            wrapper.style.height = (cards.length * card.offsetHeight * scale) + "px";
        }

        function searchGoogleImages(word) {
            window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(word + ' cute cartoon')}`, '_blank');
        }

        function handleImageUpload(input, word) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    cardData[word].image = e.target.result;
                    updateUI();
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateUI() {
            const input = document.getElementById('wordInput').value;
            const words = input.split('\n').map(w => w.trim()).filter(w => w);
            const pageSize = document.getElementById('pageSize').value;
            const orientation = document.getElementById('orientation').value;
            const frameStyle = document.getElementById('frameStyle').value;
            const mainColor = document.getElementById('mainColor').value;
            const fontFamily = document.getElementById('fontFamily').value;
            const paperArea = document.getElementById('paperArea');
            const sourceMode = document.getElementById('sourceMode').value;

            // Toggle UI elements based on mode
            const isManual = sourceMode === 'manual';
            document.getElementById('apiKeySection').style.display = isManual ? 'none' : 'block';
            document.getElementById('aiStyleSection').style.display = isManual ? 'none' : 'block';
            document.getElementById('aiGenBtn').style.display = isManual ? 'none' : 'block';

            paperArea.innerHTML = '';
            words.forEach(word => {
                if (!cardData[word]) {
                    cardData[word] = { 
                        imgScale: parseInt(document.getElementById('globalImgScale').value), 
                        textScale: parseInt(document.getElementById('globalTxtScale').value), 
                        image: null, 
                        imgPos: { x: 0, y: parseInt(document.getElementById('globalImgY').value) }, 
                        textPos: { x: 0, y: parseInt(document.getElementById('globalTxtY').value) }
                    };
                }
                const state = cardData[word];
                const cardContainer = document.createElement('div');
                cardContainer.className = `flashcard-container ${pageSize} ${orientation} shadow-sm`;
                
                let modeSpecificContent = '';

                if (isManual) {
                    // MANUAL MODE CONTENT
                    modeSpecificContent = `
                        <div class="manual-btn-group no-print">
                            <button onclick="searchGoogleImages('${word}')" class="bg-blue-500 text-white px-3 py-1 rounded-full text-[10px] font-bold shadow-md hover:bg-blue-600">ğŸ” ášá€ášá¼á”</button>
                            <button onclick="document.getElementById('fileInput_${word.replace(/\s/g, '')}').click()" class="bg-indigo-500 text-white px-3 py-1 rounded-full text-[10px] font-bold shadow-md hover:bg-indigo-600">ğŸ“‚ Upload</button>
                        </div>
                        <input type="file" id="fileInput_${word.replace(/\s/g, '')}" class="hidden" accept="image/*" onchange="handleImageUpload(this, '${word}')">
                    `;
                    
                    if (!state.image) {
                        // Placeholder if no image in manual mode
                        modeSpecificContent += `
                            <div class="absolute z-0 upload-placeholder" onclick="document.getElementById('fileInput_${word.replace(/\s/g, '')}').click()">
                                <span class="text-2xl mb-2">ğŸ“‚</span>
                                <span class="text-[10px] font-bold">á…á»á…á‘á¸á“áŸáŸ‡áŠá¾á˜áŸ’á”á¸áŠá¶á€áŸ‹ášá¼á”</span>
                            </div>
                        `;
                    }
                } else {
                    // AI MODE CONTENT
                    modeSpecificContent = `
                         <button onclick="generateSingleAI('${word}')" class="regen-btn no-print">ğŸ”„ á”áŸ’áá¼ášášá¼á”á—á¶á–</button>
                         ${!state.image ? `<div class="absolute z-0">${robotWaitingSVG}</div>` : ''}
                    `;
                }

                cardContainer.innerHTML = `
                    <div class="relative w-full h-full flex items-center justify-center">
                        <div class="flashcard ${frameStyle}" style="border-color: ${mainColor}; color: ${mainColor}; outline-color: ${mainColor};"></div>
                        
                        ${modeSpecificContent}

                        <div class="draggable image-container" style="transform: translate(${state.imgPos.x}px, ${state.imgPos.y}px)" onmousedown="startDrag(event, '${word}', 'imgPos')">
                            ${state.image ? `<img src="${state.image}" style="transform: scale(${state.imgScale/100})">` : ''}
                        </div>
                        <div class="draggable text-container" style="transform: translate(${state.textPos.x}px, ${state.textPos.y}px)" onmousedown="startDrag(event, '${word}', 'textPos')">
                            <h2 style="font-family: ${fontFamily}; font-size: ${state.textScale/100}rem; color: ${mainColor}; line-height: 1.2">${word}</h2>
                        </div>
                    </div>
                `;
                paperArea.appendChild(cardContainer);
            });
            setTimeout(adjustScale, 50);
        }

        function startDrag(e, word, type) {
            e.preventDefault();
            const element = e.currentTarget;
            const startX = e.clientX; const startY = e.clientY;
            const initialPos = { ...cardData[word][type] };
            const move = (m) => {
                const dx = m.clientX - startX; const dy = m.clientY - startY;
                cardData[word][type] = { x: initialPos.x + dx, y: initialPos.y + dy };
                element.style.transform = `translate(${cardData[word][type].x}px, ${cardData[word][type].y}px)`;
            };
            const up = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', up); };
            document.addEventListener('mousemove', move); document.addEventListener('mouseup', up);
        }

        async function generateSingleAI(word, retryCount = 0) {
            const toast = document.getElementById('loadingToast');
            toast.style.display = 'flex';
            
            // Priority: User's Key > Fallback Key
            const userKey = document.getElementById('customApiKey').value.trim();
            const activeKey = userKey || fallbackApiKey;
            
            const style = document.getElementById('imageStyle').value;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-001:predict?key=${activeKey}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instances: [{ prompt: `${word}, ${style}` }], parameters: { sampleCount: 1 } })
                });
                
                if (response.status === 429 && retryCount < 5) {
                    const delay = Math.pow(2, retryCount) * 1000;
                    await new Promise(res => setTimeout(res, delay));
                    return generateSingleAI(word, retryCount + 1);
                }

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error?.message || `HTTP error! status: ${response.status}`);
                }

                const text = await response.text();
                if (!text) throw new Error("Empty response body");
                
                const data = JSON.parse(text);
                if (data?.predictions?.[0]?.bytesBase64Encoded) {
                    cardData[word].image = `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                    updateUI();
                } else {
                    throw new Error("No image data in response");
                }
            } catch (error) { 
                console.error("AI Error:", error);
                // Simple feedback for key issues
                if (error.message.includes("API key")) {
                    alert("á”á‰áŸ’á á¶á‡á¶á˜á½á™ API Key: " + error.message);
                }
            } finally {
                if (!isGenerating) toast.style.display = 'none';
            }
        }

        async function autoFillImages() {
            const words = Object.keys(cardData).filter(w => !cardData[w].image);
            if (words.length === 0) return;
            isGenerating = true;
            for (const word of words) { await generateSingleAI(word); }
            isGenerating = false;
            document.getElementById('loadingToast').style.display = 'none';
        }

        function downloadPDF() {
            const element = document.getElementById('paperArea');
            const pageSize = document.getElementById('pageSize').value.replace('paper-', '');
            const orientation = document.getElementById('orientation').value;
            const opt = {
                margin: 0, 
                filename: `Flashcards-Ultimate-${Date.now()}.pdf`,
                image: { type: 'jpeg', quality: 1.0 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: pageSize, orientation: orientation }
            };
            html2pdf().from(element).set(opt).save();
        }

        window.addEventListener('resize', adjustScale);
        window.onload = () => {
            document.getElementById('wordInput').value = "áŸááŸ’áœááŸ’á›á¶\ná™á“áŸ’áá áŸ„áŸ‡\ná•áŸ’á›áŸ‚á”áŸ‰áŸ„á˜";
            updateUI();
        };
    </script>
</body>
</html>